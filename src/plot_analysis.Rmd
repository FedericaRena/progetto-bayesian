---
title: "R Notebook"
---

```{r}
source("include.R")
library(maps)
library(ggplot2)
library(sf)

load("../data/v300/data_agc_lomb.Rdata")
```


# "quick" na time seried check

```{r}
# colnames(df_agri)
stations = unique(df_agri$IDStations)
nas = as.data.frame(matrix(nrow=2192,ncol=141))
for (j in 1:141 ){
	nas[,j] = df_stat[[stations[j]]]$AQ_pm10
}
nas = matrix(as.integer(!is.na(nas)),nrow = 2192,ncol=141)
rownames(nas)=1:nrow(nas)
colnames(nas) = stations
# head(nas)

# pdf("na_time_series.pdf",width=10,height=9)
heatmap(t(nas[,1:70]),Colv=NA, Rowv=NA,col = c("white", "darkred"), scale='none',xlab="days",ylab="stations",
		 margins = c(3, 3),main="NA time series (white are NAs) all data")

heatmap(t(nas[,1:47]),Colv=NA, Rowv=NA,col = c("white", "darkred"), scale='none',xlab="days",ylab="stations",
		 margins = c(3, 3),main="NA time series (white are NAs) zoom 1 of 3",cexRow=0.5)
heatmap(t(nas[,48:94]),Colv=NA, Rowv=NA,col = c("white", "darkred"),scale='none',xlab="days",ylab="stations",
		 margins = c(3, 3),main="NA time series (white are NAs) zoom 2 of 3",cexRow=0.5)
heatmap(t(nas[,95:141]),Colv=NA, Rowv=NA,col = c("white", "darkred"), scale='none',xlab="days",ylab="stations",
		margins = c(3, 4.8),main="NA time series (white are NAs) zoom 3 of 3",cexRow=0.5)
# dev.off()

```







# Maps plots

## exploring the dataset with uniform measurments

```{r}
head(data_agc_lomb)
colnames(data_agc_lomb)
dim(data_agc_lomb)
attach(data_agc_lomb)
Time = as.Date(Time)
data_2016_lomb = data_agc_lomb[which(Time=="2016-01-01"),] 
detach(data_agc_lomb)

```
```{r}
spiega("temp")
```

```{r}
attach(data_2016_lomb)
head(data_2016_lomb)
unique(Latitude)
unique(Longitude)
unique(Altitude)


detach(data_2016_lomb)
```

# initial test, displaying stations

<https://askubuntu.com/questions/648244/how-do-i-create-an-animated-gif-from-still-images-preferably-with-the-command-l>

So idea: plot bubbles with size according to the pm10 value.
And maybe if we want use also a different color (like to separate high/medium/low values).

```{r,warning=FALSE}
details <- 3
extension <- ".shp"

regioni_italiane <- st_read(paste0("italia/gadm40_ITA_",details,extension))
#regioni_italiane = data.frame(regioni_italiane)
sites <- data.frame(
    longitude = unique(df_agri$Longitude), 
    latitude = unique(df_agri$Latitude)
)

pad <- 0.2 * c(-1, 1)

lombardia <- regioni_italiane[regioni_italiane$NAME_1 == "Lombardia",]

# Check if a station is inside each subregion
regioni_italiane$station_inside <- sapply(regioni_italiane$geometry, function(x) any(st_intersects(st_as_sf(sites, coords = c("longitude", "latitude")), x)))
```


```{r}
# crea mappa lombardia
mappa_migliorata <- ggplot() +
  geom_sf(data = regioni_italiane,aes(fill = station_inside), color = "lightgreen", size = 1) +
  geom_sf(data = lombardia,fill=NA, color = "red", size = 1) +
	scale_fill_manual(values = c("gold", "white")) +  # Define colors for inside/outside stations
  coord_sf(xlim = range(sites$longitude) + pad, ylim = range(sites$latitude) + pad, expand = FALSE)+
	theme(legend.position = "none")
# aggiungi stazioni
mappa_migliorata <- mappa_migliorata + geom_point(data = sites, aes(x = longitude, y = latitude), size = 1, shape = 23, fill = "darkred") 

# aggiungi grid for long and lat
mappa_migliorata <- mappa_migliorata +
	geom_hline( yintercept = data_2016_lomb$Latitude, color = "blue", size = 0.1) +  # Linee orizzontali
    geom_vline(xintercept = data_2016_lomb$Longitude, color = "blue", size = 0.1) +  # Linee verticali
    theme_classic()

# Aggiungi griglia colorata per altitudine
mappa_migliorata <- mappa_migliorata +
  geom_tile(data = data_2016_lomb, aes(x = Longitude, y = Latitude, fill = Altitude), width = 1, height = 1) +
  scale_fill_gradient(low = "lightblue", high = "darkblue") 

print(mappa_migliorata)


```

## WIND plot
### old code with the for
```{r}
cardinal_to_degree <- function(cardinal) {
  cardinal_degrees <- c(N = 0, NNE = 22.5, NE = 45, ENE = 67.5, E = 90,
  					  ESE = 112.5, SE = 135, SSE = 157.5,
  					  S = 180, SSW = 202.5, SW = 225, WSW = 247.5,
  					  W = 270, WNW = 292.5, NW = 315, NNW = 337.5)
  return(cardinal_degrees[cardinal])
}

sites <- data.frame(
	longitude = unique(df_agri$Longitude), 
	latitude = unique(df_agri$Latitude))

for (data in seq.Date(from=as.Date("2016-01-01",DATE_FORMAT),
					  to=as.Date("2016-01-02",DATE_FORMAT),by="days")){
		
	dt = as.Date(data,origin="1970-01-01")
	df_date = df_agri[which(df_agri$Time == dt),]
	print(dt)
	df_date$end_longitude <- df_date$Longitude + sin(cardinal_to_degree(df_date$WE_mode_wind_direction_10m)) * 
		df_date$WE_wind_speed_10m_mean
	df_date$end_latitude <- df_date$Latitude + cos(cardinal_to_degree(df_date$WE_mode_wind_direction_10m)) *
		df_date$WE_wind_speed_10m_mean

	
	pad = 0.2*c(-1,1)
	mappa_completa <- ggplot() +
	  geom_sf(data = regioni_italiane, fill = "lightblue", color = "black", size = 0.5)+
		  coord_sf(xlim = range(sites$longitude)+pad, 
		  		 ylim = range(sites$latitude)+pad, expand = FALSE)+
	  # geom_sf(data = world) +
		
		# fede version
	 # geom_point(data = sites, aes(x = longitude, y = latitude), size = 1, shape = 23, fill = "darkred")+
	#	geom_point(data=df_date,aes(x=Longitude,y=Latitude),size=df_date$AQ_pm10/10,alpha=0.5)+
	#	ggtitle(dt)
	
		
		
	  geom_point(data = sites, aes(x = longitude, y = latitude), size = 1, shape = 23, fill = "darkred")+
		geom_point(data=df_date,aes(x=Longitude,y=Latitude),
				   size=lerp_pm10_radius(df_date$AQ_pm10),
				   color = df_date$AQ_pm10/10, alpha=0.5)+
		geom_segment(data = df_date,
			 aes(x = Longitude, y = Latitude, xend = end_longitude, yend = end_latitude),
			 arrow = arrow(type = "open", length = unit(0.2, "inches"), ends = "last"),
			 lineend = "round", size = 0.2)+
		ggtitle(dt)
	
	print(mappa_completa)
	#ggsave(paste0("./maps_images/",dt,".jpeg"),plot=mappa_completa,width=512,height=512,units="px")
	# ggsave(paste0("./maps_images_temp/",dt,".jpeg"),plot=mappa_completa,width=512,height=512,units="px")
}
```




### new code with gganimate
```{r}
cardinal_to_degree <- function(cardinal) {
  cardinal_degrees <- c(N = 0, NNE = 22.5, NE = 45, ENE = 67.5, E = 90,
  					  ESE = 112.5, SE = 135, SSE = 157.5,
  					  S = 180, SSW = 202.5, SW = 225, WSW = 247.5,
  					  W = 270, WNW = 292.5, NW = 315, NNW = 337.5)
  return(cardinal_degrees[cardinal])
}

library(gganimate)
theme_set(theme_bw())

wind_arrows <- data.frame(
  longitude = df_agri$Longitude,
  latitude = df_agri$Latitude,
  direction = cardinal_to_degree(df_agri$WE_mode_wind_direction_10m),
  intensity = df_agri$WE_wind_speed_10m_mean
)
# Calcola le coordinate di fine delle frecce in base alla direzione e all'intensitÃ 
wind_arrows$end_longitude <- wind_arrows$longitude + sin(wind_arrows$direction) * wind_arrows$intensity
wind_arrows$end_latitude <- wind_arrows$latitude + cos(wind_arrows$direction) * wind_arrows$intensity

date_time = seq.Date(from=as.Date("2016-01-01",DATE_FORMAT),
					  to=as.Date("2016-01-03",DATE_FORMAT),by="days")
date_time = as.Date(date_time)
df_date = df_agri[which(df_agri$Time %in% date_time),]
wind_arrows = wind_arrows[which(df_agri$Time %in% date_time),]

pad = 0.2*c(-1,1)
mappa_completa <- ggplot() +
  geom_sf(data = regioni_italiane, fill = "lightblue", color = "black", size = 0.5)+
	  coord_sf(xlim = range(na.omit(wind_arrows$longitude))+pad,
	  		 ylim = range(na.omit(wind_arrows$latitude))+pad, expand = FALSE)+
  geom_point(data = sites, aes(x = longitude, y = latitude), 
  		   size = 1, shape = 23, fill = "darkred")+
#   geom_point(data=df_date,aes(x=Longitude,y=Latitude),
# 			   size=lerp_pm10_radius(df_date$AQ_pm10),
# 			   color = lerp_pm10_color(df_date$AQ_pm10), alpha=0.5)+
geom_segment(data = wind_arrows,
			 aes(x = longitude, y = latitude, xend = end_longitude, yend = end_latitude),
			 arrow = arrow(type = "closed", length = unit(0.2, "inches"), ends = "last"),
			 lineend = "round", size = 0.5)+
  ggtitle(dt)+
  transition_time(Time)+
  labs(title = "Day: {frame_time}")

file_name = "wind_gif"
# gif
output_file <- paste0("./gifs/",file_name,".gif")
anim_save(output_file,mappa_completa)

#video ??


```

# MAPS plot again
## LERP function
```{r}
lerp_pm10_radius <- function(val){
	radius_0 = 1
	radius_f = 15
	
	min_max = range(df_agri$AQ_pm10[!is.na(df_agri$AQ_pm10)])
	pm10_0 = min_max[1]
	pm10_f = min_max[2]

	# linear, you can use any function!
	return_val = radius_0 + (radius_f - radius_0) * ((val - pm10_0) / (pm10_f - pm10_0))
	return(return_val) 
}

lerp_pm10_color <- function(val) {
  color_0 <- col2rgb("#008F39")
  color_f <- col2rgb("#F80000")
  
  min_max <- range(df_agri$AQ_pm10[!is.na(df_agri$AQ_pm10)])
  pm10_0 <- min_max[1]
  pm10_f <- min_max[2]
  
  return_vals <- vector("list", length = length(val))
  
  for (i in seq_along(val)) {
    if (!is.nan(val[i])) {
      return_val <- color_0 + (color_f - color_0) * ((val[i] - pm10_0) / (pm10_f - pm10_0))
      return_vals[[i]] <- return_val
    } else {
      return_vals[[i]] <- rep(255, 3)  # Set RGB values to 255 (white)
    }
  }
  
  # Convert RGB components to color strings
  colors <- lapply(return_vals, function(rgb_vec) {
    rgb_string <- rgb(rgb_vec[1], rgb_vec[2], rgb_vec[3], maxColorValue = 255)
    return(rgb_string)
  })
  
  return(colors) 
}

```


## creating images for the gif

devtools::install_github("dgrtwo/gganimate")

```{r}
library(gganimate)
theme_set(theme_bw())

sites <- data.frame(
	longitude = unique(df_agri$Longitude), 
	latitude = unique(df_agri$Latitude))


date_time = seq.Date(from=as.Date("2016-01-01",DATE_FORMAT),
					  to=as.Date("2016-01-14",DATE_FORMAT),by="days")
date_time = as.Date(date_time)
	
df_date = df_agri[which(df_agri$Time %in% date_time),]


pad = 0.2*c(-1,1)
mappa_completa <- mappa_migliorata +
  geom_point(data=df_date,aes(x=Longitude,y=Latitude),
			   size=lerp_pm10_radius(df_date$AQ_pm10),
			   color = lerp_pm10_color(df_date$AQ_pm10), alpha=0.5)+
  ggtitle(dt)+
  transition_time(Time)+labs(title = "Day: {frame_time}")


file_name = "map_gif"
# gif
output_file <- paste0("./gifs/",file_name,".gif")
anim_save(output_file,mappa_completa)
```



# Trend plots - normal plots

## create video

# TREND plots

```{r}
stations = unique(df_agri$IDStations)
cols = colora(6,970,show=)

for (st in stations[1:4]){
	df_st = df_stat[[st]]
	data2016 = subset(df_st,Time>="2016-01-01" & Time<="2016-12-31")
	data2017 = subset(df_st,Time>="2017-01-01" & Time<="2017-12-31")
	data2018 = subset(df_st,Time>="2018-01-01" & Time<="2018-12-31")
	data2019 = subset(df_st,Time>="2019-01-01" & Time<="2019-12-31")
	data2020 = subset(df_st,Time>="2020-01-01" & Time<="2020-12-31")
	data2021 = subset(df_st,Time>="2021-01-01" & Time<="2021-12-31")
	
	
	plot(as.Date(format(data2016$Time,"%d %m"),"%d %m"),data2016$AQ_pm10 ,type="l",col=cols[1],
		 xlab="time",ylab="PM_10 values",main=paste0("Station ",st,", all years"),
		 ylim=range(na.omit(df_st$AQ_pm10)))
	lines(as.Date(format(data2017$Time,"%d %m"),"%d %m"),data2017$AQ_pm10,type="l",col=cols[2])
	lines(as.Date(format(data2018$Time,"%d %m"),"%d %m"),data2018$AQ_pm10,type="l",col=cols[3])
	lines(as.Date(format(data2019$Time,"%d %m"),"%d %m"),data2019$AQ_pm10,type="l",col=cols[4])
	lines(as.Date(format(data2020$Time,"%d %m"),"%d %m"),data2020$AQ_pm10,type="l",col=cols[5])
	lines(as.Date(format(data2021$Time,"%d %m"),"%d %m"),data2021$AQ_pm10,type="l",col=cols[6])
	legend('topright', levels(as.factor(2016:2021)), fill=cols, bty='n', cex = 0.6)

}
```


# Trend plots
## 1 station - multiple years

```{r}
library(lubridate)


stations = unique(df_agri$IDStations)
cols = colora(6,970,show=F)

# for semplicity let's do one station for now, can be expanded with a simple for loop
st = stations[1]
df_st = df_stat[[st]]

data_16_to_21 = subset(df_st,Time>="2016-01-01" & Time<="2021-12-31")
data_16_to_21$month_day =paste0("1990-",substr(data_16_to_21$Time,6,10))


data_16_to_21$month_day = as.Date(data_16_to_21$month_day)
data_16_to_21$t = format(data_16_to_21$Time,"%j")

# Crea il grafico ggplot
time_trend <- ggplot(data_16_to_21,aes(x = month_day, 
  			     y = AQ_pm10,
  			     group=year(Time), 
			     color = as.factor(year(Time)))) +
	
  geom_line() +
	
  labs(x = "Year", y = "PM_10 values", title = paste0("Station ", st, ", all years")) +
  ylim(range(na.omit(data_16_to_21$AQ_pm10))) +
  scale_x_date(date_labels = "%b",date_breaks = "1 month")+

  scale_color_manual(values = cols) +
  theme(legend.position = "top")+
  theme_classic() 

print(time_trend)
```

### animation
```{r}
time_trend <- time_trend + transition_reveal(as.numeric(t)) + geom_point() + view_follow(fixed_x = T,fixed_y = T)


b <- animate(time_trend, duration = 20, fps = 20, renderer = av_renderer())


file_name = "time_trend"
output_file <- paste0("./gifs/",file_name,".mp4")
anim_save(output_file,b)

```


## 1 year - multiple stations
```{r}
cols = colora(10,970,show=0)

stations = unique(df_agri$IDStations)

# for semplicity let's do one year for now, can be expanded with a simple for loop
year = 2016
# and also a subset of stations
st = stations[1:4]

data_year<-df_agri %>% subset(IDStations %in% st)

data_year = data_year[data_year$Time>=as.Date(paste0(year,"-01-01"),"%Y-%m-%d") &
					  data_year$Time<=as.Date(paste0(year,"-12-31"),"%Y-%m-%d"),]

# Crea il grafico ggplot
station_trend <- ggplot(data_year,aes(x = Time, 
  			     y = AQ_pm10,
  			     group=IDStations, 
			     color = as.factor(IDStations))) +
	
  geom_line() +
  labs(x = "Stations", y = "PM_10 values", title = paste0("Year: ",year, ", all stations")) +
  ylim(range(na.omit(data_16_to_21$AQ_pm10))) +
  scale_color_manual(values = cols) +
  theme(legend.position = "top")+
  scale_x_date(date_labels = "%b",date_breaks = "1 month")+
  theme(panel.grid = element_blank()) 


station_trend
```



### animation
```{r}
station_trend <- station_trend + transition_reveal(Time) + geom_point() + view_follow(fixed_x = T,fixed_y = T)


b <- animate(station_trend, duration = 20, fps = 20, renderer = av_renderer())


file_name = "station_trend"
output_file <- paste0("./gifs/",file_name,".mp4")
anim_save(output_file,b)

```

```{r}
head(df_agri)
```


# TO DO LIST:
- aggiungere anche la svizzera?
- add legends to ggplots
- vector map of wind - update on the grid map

- multi year plots






