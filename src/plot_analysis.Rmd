---
title: "R Notebook"
output: html_notebook
---

```{r}
source("include.R")
library(maps)
library(ggplot2)
library(sf)
```

# "veloce" na check
```{r}
colnames(df_agri)
stations = unique(df_agri$IDStations)
nas = as.data.frame(matrix(nrow=2192,ncol=141))
for (j in 1:141 ){
	nas[,j] = df_stat[[stations[j]]]$AQ_pm10
}
nas = matrix(as.integer(!is.na(nas)),nrow = 2192,ncol=141)
rownames(nas)=1:nrow(nas)
colnames(nas) = stations
head(nas)
pdf("na_time_series.pdf")
heatmap(t(nas),Colv=NA, Rowv=NA,col = c("white", "darkred"), scale='column',xlab="days",ylab="stations",
		 margins = c(3, 3))
dev.off()

```






# Maps plots


# displaying pm10 levels
Idea: plot the values for pm10 each day, like with "bubbles" of ggplot, so to get 2192 plots. And then combine all them in a single gif, which shows the evolution over time of those pm10 values.

<https://askubuntu.com/questions/648244/how-do-i-create-an-animated-gif-from-still-images-preferably-with-the-command-l>

So idea: plot bubbles with size according to the pm10 value.
And maybe if we want use also a different color (like to separate high/medium/low values).

```{r}
regioni_italiane <- st_read("italia/gadm40_ITA_1.shp") 

sites <- data.frame(
	longitude = unique(df_agri$Longitude), 
	latitude = unique(df_agri$Latitude))

pad = 0.2*c(-1,1)
mappa_completa <- ggplot() +
  geom_sf(data = regioni_italiane, fill = "lightblue", color = "black", size = 0.5)+
	  coord_sf(xlim = range(sites$longitude)+pad, 
	  		 ylim = range(sites$latitude)+pad, expand = FALSE)+
  # geom_sf(data = world) +
  geom_point(data = sites, aes(x = longitude, y = latitude), size = 1, shape = 23, fill = "darkred")
 
print(mappa_completa)
```

# LERP function
```{r}
lerp_pm10_radius <- function(val){
	radius_0 = 1
	radius_f = 15
	
	min_max = range(df_agri$AQ_pm10[!is.na(df_agri$AQ_pm10)])
	pm10_0 = min_max[1]
	pm10_f = min_max[2]

	# linear, you can use any function!
	return_val = radius_0 + (radius_f - radius_0) * ((val - pm10_0) / (pm10_f - pm10_0))
	return(return_val) 
}

lerp_pm10_color <- function(val) {
  color_0 <- col2rgb("#008F39")
  color_f <- col2rgb("#F80000")
  
  min_max <- range(df_agri$AQ_pm10[!is.na(df_agri$AQ_pm10)])
  pm10_0 <- min_max[1]
  pm10_f <- min_max[2]
  
  return_vals <- vector("list", length = length(val))
  
  for (i in seq_along(val)) {
    if (!is.nan(val[i])) {
      return_val <- color_0 + (color_f - color_0) * ((val[i] - pm10_0) / (pm10_f - pm10_0))
      return_vals[[i]] <- return_val
    } else {
      return_vals[[i]] <- rep(255, 3)  # Set RGB values to 255 (white)
    }
  }
  
  # Convert RGB components to color strings
  colors <- lapply(return_vals, function(rgb_vec) {
    rgb_string <- rgb(rgb_vec[1], rgb_vec[2], rgb_vec[3], maxColorValue = 255)
    return(rgb_string)
  })
  
  return(colors) 
}

```


# creating images for the gif

```{r}
sites <- data.frame(
	longitude = unique(df_agri$Longitude), 
	latitude = unique(df_agri$Latitude))

for (data in seq.Date(from=as.Date("2016-01-01",DATE_FORMAT),
					  to=as.Date("2016-02-01",DATE_FORMAT),by="days")){
		
	dt = as.Date(data,origin="1970-01-01")
	df_date = df_agri[which(df_agri$Time == dt),]
	print(dt)
	
	pad = 0.2*c(-1,1)
	mappa_completa <- ggplot() +
	  geom_sf(data = regioni_italiane, fill = "lightblue", color = "black", size = 0.5)+
		  coord_sf(xlim = range(sites$longitude)+pad, 
		  		 ylim = range(sites$latitude)+pad, expand = FALSE)+
	  # geom_sf(data = world) +
		
		# fede version
	 # geom_point(data = sites, aes(x = longitude, y = latitude), size = 1, shape = 23, fill = "darkred")+
	#	geom_point(data=df_date,aes(x=Longitude,y=Latitude),size=df_date$AQ_pm10/10,alpha=0.5)+
	#	ggtitle(dt)
	
	  geom_point(data = sites, aes(x = longitude, y = latitude), size = 1, shape = 23, fill = "darkred")+
		geom_point(data=df_date,aes(x=Longitude,y=Latitude),
				   size=lerp_pm10_radius(df_date$AQ_pm10),color = lerp_pm10_color(df_date$AQ_pm10), alpha=0.5)+
		ggtitle(dt)
	
	# print(mappa_completa)
	#ggsave(paste0("./maps_images/",dt,".jpeg"),plot=mappa_completa,width=512,height=512,units="px")
	ggsave(paste0("./maps_images_temp/", dt, ".jpeg"), plot = mappa_completa, width = 1024, height = 1024, units = "px")


}
```

# create gif and video
```{r}
library(magick)
path_to_folder <- "./maps_images_temp/"
image_files <- list(list.files(path_to_folder, pattern = "*.jpeg", full.names = TRUE) )
images <- lapply(image_files, image_read)
output_gif <- image_animate(images[[1]], fps = 10)  # Adjust the 'fps' as needed

file_name = "map_gif"
output_file <- paste0("./gifs/",file_name,".gif")
image_write(output_gif, path = output_file)
```

# create video
```{r}
library(imager)
library(av)

# Set up the video writer

path_to_folder <- "./maps_images_temp/"
image_files <- list.files(path_to_folder, pattern = "*.jpeg", full.names = TRUE) 
images <- lapply(image_files, imager::load.image)

file_name <- "map_video"
output_file <- paste0("./gifs/",file_name,".mp4")


av::av_encode_video(image_files, framerate = 5,
                    output = output_file,codec ="libx264" )
```



# Trend plots
```{r}
stations = unique(df_agri$IDStations)
cols = colora(6,97,show=1)

for (st in stations[1:4]){
	df_st = df_stat[[st]]
	data2016 = subset(df_st,Time>="2016-01-01" & Time<="2016-12-31")
	data2017 = subset(df_st,Time>="2017-01-01" & Time<="2017-12-31")
	data2018 = subset(df_st,Time>="2018-01-01" & Time<="2018-12-31")
	data2019 = subset(df_st,Time>="2019-01-01" & Time<="2019-12-31")
	data2020 = subset(df_st,Time>="2020-01-01" & Time<="2020-12-31")
	data2021 = subset(df_st,Time>="2021-01-01" & Time<="2021-12-31")
	
	
	plot(as.Date(format(data2016$Time,"%d %m"),"%d %m"),data2016$AQ_pm10 ,type="l",col=cols[1],
		 xlab="time",ylab="PM_10 values",main=paste0("Station ",st,", all years"),
		 ylim=range(na.omit(df_st$AQ_pm10)))
	lines(as.Date(format(data2017$Time,"%d %m"),"%d %m"),data2017$AQ_pm10,type="l",col=cols[2])
	lines(as.Date(format(data2018$Time,"%d %m"),"%d %m"),data2018$AQ_pm10,type="l",col=cols[3])
	lines(as.Date(format(data2019$Time,"%d %m"),"%d %m"),data2019$AQ_pm10,type="l",col=cols[4])
	lines(as.Date(format(data2020$Time,"%d %m"),"%d %m"),data2020$AQ_pm10,type="l",col=cols[5])
	lines(as.Date(format(data2021$Time,"%d %m"),"%d %m"),data2021$AQ_pm10,type="l",col=cols[6])
	legend('topright', levels(as.factor(2016:2021)), fill=cols, bty='n', cex = 0.6)

}
```


```{r}
cols = colora(10,show=0)
for (year in 2016:2021){
	for (i in 1:length(stations)){
		st = stations[i]
		df_st = df_stat[[st]]
		df_st = df_st[df_st$Time>=as.Date(paste0(year,"-01-01"),"%Y-%m-%d") &
					  df_st$Time<=as.Date(paste0(year,"-12-31"),"%Y-%m-%d"),]
		if(st=="1264"){
			plot(df_st$Time,df_st$AQ_pm10,type="l",col=cols[i%%10],
				 ylim=range(na.omit(df_agri$AQ_pm10)),main=paste0(year," all the stations"),
				 xlab="months",ylab="PM_10 values")
		} else{
			lines(df_st$Time,df_st$AQ_pm10,type="l",col=cols[i%%10])
		}
	}
}
```












